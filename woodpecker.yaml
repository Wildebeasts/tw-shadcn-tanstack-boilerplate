steps:
  - name: Building FE
    image: bash
    commands:
      # Install Node.js using NodeSource repository (if not installed)
      - curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
      - sudo apt-get install -y nodejs
      
      # Enable pnpm
      - corepack enable pnpm
      
      # Install dependencies
      - pnpm install
      
      # Add missing dependencies (if not in package.json)
      - pnpm add @mantine/core uuid
      
      # Build the project
      - pnpm build
      
      # Verify build output
      - ls -la
      - ls -la dist/ || echo "No dist directory found"

  - name: Deploy FE
    image: bash
    environment:
      SSH_PRIVATE_KEY:
        from_secret: SSH_KEY
      REMOTE_HOST: 192.168.2.245
      REMOTE_USER: root
      REMOTE_TARGET_PATH: /root
    commands:
      # Install SSH client if not present
      - sudo apt-get update && sudo apt-get install -y openssh-client rsync
      
      # Setup SSH
      - mkdir -p ~/.ssh
      - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
      - chmod 600 ~/.ssh/id_rsa
      - ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts
      
      # Verify dist directory exists
      - ls -la dist/ || (echo "Build artifacts not found!" && exit 1)
      
      # Create target directory and copy files
      - ssh -i ~/.ssh/id_rsa $REMOTE_USER@$REMOTE_HOST "mkdir -p $REMOTE_TARGET_PATH/Bean-Journal-Web-FE"
      - rsync -avz -e "ssh -i ~/.ssh/id_rsa" ./dist/ $REMOTE_USER@$REMOTE_HOST:$REMOTE_TARGET_PATH/Bean-Journal-Web-FE/dist/
      
      # Deploy with PM2
      - |
        ssh -i ~/.ssh/id_rsa $REMOTE_USER@$REMOTE_HOST "
          cd $REMOTE_TARGET_PATH/Bean-Journal-Web-FE &&
          npm install -g pm2 serve &&
          pm2 delete BJ_FE || true &&
          pm2 start serve --name BJ_FE -- -s ./dist/ -l 3000 &&
          pm2 save
        "
      
      # Cleanup
      - rm -f ~/.ssh/id_rsa
